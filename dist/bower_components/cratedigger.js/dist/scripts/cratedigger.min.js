!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t:e.cratedigger=t(e)}(this,function(e){"use strict";function t(e){for(var t,n,o=e.length;o;t=parseInt(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n);return e}var n,o,a,i,s,r,d,c,l,u,m,f,E,h,p,g,v,T,y,w,R,P,M,x,I,b,H,C,O,z,W,N={},S={},L=!!document.querySelector&&!!e.addEventListener,F=[],B=[],j=[],Q="closed",D=!0,X={x:0,y:0},k={x:0,y:0},A={x:0,y:0},G=-1,Y=-1,U=0,V={debug:!0,canvasWidth:null,canvasHeight:null,nbCrates:2,recordsPerCrate:24,lightIntensity:1,cameraMouseMove:!0,backgroundColor:1118481,sleeveColor:853762,closeInfoPanelOnClick:!0,closeInfoPanelOnScroll:!0,infoPanelOpacity:.9,postprocessing:!0,blurAmount:.4,updateCanvasSizeOnWindowResize:!0,infoPanelOpened:function(){},infoPanelClosed:function(){},elements:{rootContainerId:"cratedigger",canvasContainerId:"cratedigger-canvas",loadingContainerId:"cratedigger-loading",infosContainerId:"cratedigger-infos",titleContainerId:"cratedigger-record-title",artistContainerId:"cratedigger-record-artist",coverContainerId:"cratedigger-record-cover"},constants:{recordMoveTime:1e3,cameraMoveTime:800,infosOpenTime:800,recordShownY:25,recordFlippedY:110,targetBasePosition:{x:-20,y:10,z:0},cameraBasePosition:{x:280,y:200,z:180},cameraFocusPosition:{x:150,y:180,z:80},cameraMouseMoveSpeedY:.07,cameraMouseMoveSpeedZ:.03,grabSensitivity:6}},q=function(e,t,n){this.id=e,this.crateId=t,this.pos=n,this.state="out",this.recordXPos=-62+135/N.recordsPerCrate*n,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,1.5,100,1,1,1),new THREE.MeshFaceMaterial(xt(null,!1))),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(50,0,0)),this.mesh.position.set(this.recordXPos,0,0),this.mesh.rotation.z=Math.PI/2,this.mesh.recordId=e,this.mesh.visible=!1,this.absolutePosition=new THREE.Vector3,this.pushRecord()};q.prototype.log=function(){console.log("Record nÂ°",this.id,"crateId =",this.crateId,"pos =",this.pos)},q.prototype.showRecord=function(){"shown"!==this.state&&(this.state="shown",this.absolutePosition.setFromMatrixPosition(this.mesh.matrixWorld),new TWEEN.Tween(this.mesh.position).to({y:N.constants.recordShownY},N.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2},N.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(m.position).to({x:this.recordXPos,y:50+N.constants.recordShownY,z:this.absolutePosition.z},N.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(u.position).to({x:this.recordXPos+N.constants.cameraFocusPosition.x,y:N.constants.cameraFocusPosition.y,z:this.absolutePosition.z+N.constants.cameraFocusPosition.z},N.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},q.prototype.pushRecord=function(){"pushed"!=this.state&&(this.state="pushed",new TWEEN.Tween(this.mesh.position).to({y:0},N.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2+Math.PI/7},N.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},q.prototype.pullRecord=function(){"pulled"!==this.state&&(this.state="pulled",new TWEEN.Tween(this.mesh.position).to({y:0},N.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2-Math.PI/7},N.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},q.prototype.flipRecord=function(e){this.state="flipped",new TWEEN.Tween(this.mesh.position).to({y:N.constants.recordFlippedY},N.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).delay(N.constants.infosOpenTime/4).to({y:Math.PI},N.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(m.position).to({x:this.recordXPos,y:N.constants.recordFlippedY+50,z:this.absolutePosition.z},N.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),new TWEEN.Tween(u.position).to({x:this.recordXPos+N.constants.cameraFocusPosition.x+80,y:N.constants.cameraFocusPosition.y-50},N.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start()},q.prototype.flipBackRecord=function(e){"flipped"===this.state&&(new TWEEN.Tween(this.mesh.position).delay(N.constants.infosOpenTime/2).to({y:0},N.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({y:0},N.constants.infosOpenTime/2).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),new TWEEN.Tween(m.position).delay(N.constants.infosOpenTime/2).to({x:this.recordXPos,y:75,z:this.absolutePosition.z},N.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(u.position).to({x:this.recordXPos+N.constants.cameraFocusPosition.x,y:N.constants.cameraFocusPosition.y},N.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())};var Z=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},J=function(){D&&(requestAnimationFrame(J),K(),N.debug&&c.update())},K=function(){TWEEN.update(),at(),N.cameraMouseMove&&(A.x=.25*(X.x/H-.5),A.y=.25*(X.y/H-.5),I.rotation.y+=N.constants.cameraMouseMoveSpeedY*(A.x-I.rotation.y),I.rotation.z+=N.constants.cameraMouseMoveSpeedZ*(A.y-I.rotation.z)),u.lookAt(m.position),N.postprocessing?(l.overrideMaterial=x,f.render(l,u,R),l.overrideMaterial=null,v.render()):f.render(l,u)},$=function(){for(var e=0;e<B.length;e++)B[e].data=null,B[e].mesh.visible=!1;U=0,j=[]},_=function(e,n){U>0&&$(),n&&(e=t(e));for(var o=0;o<B.length&&o<e.length;o++)B[o].data=e[o],B[o].mesh.visible=!0,B[o].mesh.material.materials=xt(e[o].cover,e[o].hasSleeve);U=e.length<B.length?e.length:B.length,j=e,console.log("loadedRecords",U)},et=function(){var e=j;e=t(e),_(e)},tt=function(e){"opened"===Q?ot():"opening"!==Q&&"closing"!==Q&&(G=e)},nt=function(){dt(B[G]),Q="opening",B[G].flipRecord(function(){Q="opened"}),N.infoPanelOpened(),setTimeout(function(){Ct(i)},300)},ot=function(){"opened"===Q&&(Ht(i),Q="closing",B[G].flipBackRecord(function(){Q="closed",N.infoPanelClosed()}))},at=function(){if("closed"===Q&&Y!=G){Y=G;for(var e=0;U>e;e++)-1==G?B[e].pushRecord():e>G&&e>B[G].crateId*N.recordsPerCrate&&e<B[G].crateId*N.recordsPerCrate+N.recordsPerCrate?B[e].pullRecord():e==G?B[e].showRecord():B[e].pushRecord()}},it=function(){"opened"===Q?ot():"opening"!==Q&&"closing"!==Q&&(G=-1,new TWEEN.Tween(m.position).to({x:N.constants.targetBasePosition.x,y:N.constants.targetBasePosition.y,z:N.constants.targetBasePosition.z},N.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(u.position).to({x:N.constants.cameraBasePosition.x,y:N.constants.cameraBasePosition.y,z:N.constants.cameraBasePosition.z},N.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},st=function(){-1==G?tt(U-1):U-1>G?tt(G+1):tt(0)},rt=function(){-1==G?tt(0):G>0?tt(G-1):tt(U-1)},dt=function(e){e.data.title&&(s.innerHTML=e.data.title),e.data.artist&&(r.innerHTML=e.data.artist),e.data.cover&&(d.style.backgroundImage="url("+e.data.cover+")")},ct=function(e){var t=0,n=0,o=0,a=0,i=this;if(e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),i.offsetParent)do o+=i.offsetLeft,a+=i.offsetTop;while(i=i.offsetParent);X.x=t-o,X.y=n-a},lt=function(e){return"closed"===Q?It(e)<0?st():rt():"opened"===Q&&N.closeInfoPanelOnScroll&&ot(),!1},ut=function(e){if("closed"===Q){var t=new THREE.Vector3((e.x-f.domElement.offsetLeft)/f.domElement.width*2-1,2*-((e.y-f.domElement.offsetTop)/f.domElement.height)+1,.5);t.unproject(u);var n=new THREE.Raycaster(u.position,t.sub(u.position).normalize()),o=n.intersectObjects(b.children,!0);if(o.length>0){for(var a,i=0;i<o.length&&o[i].object.recordId;i++)if(o[i].object.visible&&o[i].object.recordId>=0){a=B[o[i].object.recordId];break}a?G===a.id?nt():tt(a.id):it()}else it()}},mt=function(){clearInterval(z),"closed"===Q?(Et(X.y),k={x:X.x,y:X.y}):"opened"===Q&&N.closeInfoPanelOnClick&&ot()},ft=function(){clearInterval(z),classie.remove(f.domElement,"grab"),bt(k,X,N.constants.grabSensitivity)&&ut(k)},Et=function(e){z=setTimeout(function(){classie.add(f.domElement,"grab");var t=(e-X.y)/C;t>0?rt():0>t&&st(),Et(e)},75)},ht=function(){Ot(),zt(),f.setSize(H,C),u.aspect=H/C,u.updateProjectionMatrix(),y.uniforms.tDepth.value=R,y.uniforms.size.value.set(H,C),y.uniforms.textel.value.set(1/H,1/C),T.uniforms.resolution.value.set(1/(H*O),1/(C*O))},pt=function(){l=new THREE.Scene,f=new THREE.WebGLRenderer({antialias:!0}),f.setSize(H,C),o.appendChild(f.domElement),f.domElement.id="context",f.setClearColor(N.backgroundColor,1),u=new THREE.PerspectiveCamera(45,H/C,.1,2e4),u.focalLength=45,u.frameSize=32,u.setLens(u.focalLength,u.frameSize),m=new THREE.Object3D,u.lookAt(m.position),E=new THREE.Projector;var e=THREE.ImageUtils.loadTexture("img/wood.jpg");e.anisotropy=f.getMaxAnisotropy(),W=new THREE.MeshLambertMaterial({map:e}),I=new THREE.Object3D,b=new THREE.Object3D,l.add(I),I.add(b),wt(),Pt(),h=new THREE.PointLight(16777215,1.1*N.lightIntensity),h.position.set(300,80,0),l.add(h),p=new THREE.PointLight(16777215,.6*N.lightIntensity),p.position.set(-100,300,1e3),l.add(p),g=new THREE.PointLight(16777215,.6*N.lightIntensity),g.position.set(-100,300,-1e3),l.add(g),N.postprocessing&&gt(),n.addEventListener("DOMMouseScroll",lt,!1),n.addEventListener("mousewheel",lt,!1),n.addEventListener("mousemove",ct,!1),n.addEventListener("mousedown",mt,!1),n.addEventListener("mouseup",ft,!1),N.updateCanvasSizeOnWindowResize&&window.addEventListener("resize",ht,!1),n.style.position="relative",o.style.position="absolute",i.style.position="absolute",a.style.position="absolute",console.log(C),zt(),i.style.display="none",Ht(a),N.debug&&(vt(),Tt()),it(),J()},gt=function(){P=THREE.ShaderLib.depthRGBA,M=THREE.UniformsUtils.clone(P.uniforms),x=new THREE.ShaderMaterial({fragmentShader:P.fragmentShader,vertexShader:P.vertexShader,uniforms:M}),x.blending=THREE.NoBlending,R=new THREE.WebGLRenderTarget(H,C,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),v=new THREE.EffectComposer(f),v.addPass(new THREE.RenderPass(l,u)),y=new THREE.ShaderPass(THREE.DoFShader),y.uniforms.tDepth.value=R,y.uniforms.size.value.set(H,C),y.uniforms.textel.value.set(1/H,1/C),y.uniforms.znear.value=u.near,y.uniforms.zfar.value=u.far,y.uniforms.focalDepth.value=5,y.uniforms.focalLength.value=u.focalLength,y.uniforms.fstop.value=8,y.uniforms.showFocus.value=!1,y.uniforms.manualdof.value=!0,y.uniforms.ndofstart.value=11,y.uniforms.ndofdist.value=80,y.uniforms.fdofstart.value=0,y.uniforms.fdofdist.value=100,y.uniforms.CoC.value=.03,y.uniforms.vignetting.value=!1,y.uniforms.autofocus.value=!0,y.uniforms.focus.value.set(.35,.35),y.uniforms.maxblur.value=N.blurAmount,y.uniforms.threshold.value=0,y.uniforms.gain.value=0,y.uniforms.bias.value=0,y.uniforms.fringe.value=0,T=new THREE.ShaderPass(THREE.FXAAShader),T.uniforms.resolution.value.set(1/(H*O),1/(C*O)),T.renderToScreen=!0,v.addPass(y),v.addPass(T)},vt=function(){c=new Stats,c.domElement.style.position="absolute",c.domElement.style.left="0",c.domElement.style.top="0",n.appendChild(c.domElement);var e=new THREE.Mesh(new THREE.BoxGeometry(20,20,20,1,1,1));e.position.set(h.position.x,h.position.y,h.position.z),l.add(e)},Tt=function(){var e,t,n;w=new dat.GUI,N.postprocessing&&(e=w.addFolder("Camera"),t=e.add(u,"focalLength",28,200).name("Focal Length"),t.onChange(yt),n=w.addFolder("Depth of Field"),n.add(y.uniforms.focalDepth,"value",0,10).name("Focal Depth"),n.add(y.uniforms.fstop,"value",0,22).name("F Stop"),n.add(y.uniforms.maxblur,"value",0,3).name("max blur"),n.add(y.uniforms.showFocus,"value").name("Show Focal Range"),n.add(y.uniforms.manualdof,"value").name("Manual DoF"),n.add(y.uniforms.ndofstart,"value",0,200).name("near start"),n.add(y.uniforms.ndofdist,"value",0,200).name("near falloff"),n.add(y.uniforms.fdofstart,"value",0,200).name("far start"),n.add(y.uniforms.fdofdist,"value",0,200).name("far falloff"),n.add(y.uniforms.CoC,"value",0,.1).step(.001).name("circle of confusion"),n.add(y.uniforms.vignetting,"value").name("Vignetting"),n.add(y.uniforms.vignout,"value",0,2).name("outer border"),n.add(y.uniforms.vignin,"value",0,1).step(.01).name("inner border"),n.add(y.uniforms.vignfade,"value",0,22).name("fade at"),n.add(y.uniforms.autofocus,"value").name("Autofocus"),n.add(y.uniforms.focus.value,"x",0,1).name("focus x"),n.add(y.uniforms.focus.value,"y",0,1).name("focus y"),n.add(y.uniforms.threshold,"value",0,1).step(.01).name("threshold"),n.add(y.uniforms.gain,"value",0,100).name("gain"),n.add(y.uniforms.bias,"value",0,4).step(.01).name("bias"),n.add(y.uniforms.fringe,"value",0,5).step(.01).name("fringe"),n.add(y.uniforms.noise,"value").name("Use Noise"),n.add(y.uniforms.namount,"value",0,.001).step(1e-4).name("dither"),n.add(y.uniforms.depthblur,"value").name("Blur Depth"),n.add(y.uniforms.dbsize,"value",0,5).name("blur size")),w.close()},yt=function(){u.setLens(u.focalLength,u.frameSize),u.updateProjectionMatrix(),y.uniforms.focalLength.value=u.focalLength},wt=function(){for(var e=0;e<N.nbCrates;e++){var t=Rt(e);b.add(t)}b.position.z=-(110-110*N.nbCrates)/2},Rt=function(e){F[e]=new THREE.Object3D;var t=new THREE.Mesh(new THREE.BoxGeometry(200,10,100),W);F[e].add(t);var n=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),W);if(n.position.set(0,35,-55),n.rotation.x=Math.PI/2,F[e].add(n),0===e){var o=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),W);o.position.set(0,35,55),o.rotation.x=Math.PI/2,F[e].add(o)}var a=new THREE.Mesh(new THREE.BoxGeometry(80,10,120),W);a.position.set(-105,35,0),a.rotation.z=Math.PI/2,F[e].add(a);var i=new THREE.Mesh(new THREE.BoxGeometry(40,10,100),W);return i.position.set(95,25,0),i.rotation.z=Math.PI/2,F[e].add(i),F[e].position.z=-110*e,F[e]},Pt=function(){for(var e=0,t=0;t<F.length;t++)for(var n=0;n<N.recordsPerCrate;n++)Mt(e,t,n),e++},Mt=function(e,t,n){var o=new q(e,t,n);F[t].add(o.mesh),B.push(o)},xt=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.src=e?e:"";var o=400,a=400,i=document.createElement("canvas");i.width=i.height=400;var s=new THREE.Texture(i);n.onload=function(){if(t){var e=new Image;e.src="img/sleeve.png",e.onload=function(){var t=i.getContext("2d");t.translate(o/2,a/2),t.rotate(Math.PI/2),t.translate(-o/2,-a/2),t.drawImage(n,130,130,135,135),t.drawImage(e,0,0,400,400),s.needsUpdate=!0}}else{var r=i.getContext("2d");r.translate(o/2,a/2),r.rotate(Math.PI/2),r.translate(-o/2,-a/2),r.drawImage(n,0,0,400,400),s.needsUpdate=!0}};var r=new THREE.MeshLambertMaterial({color:N.sleeveColor}),d=[r,r,r,new THREE.MeshLambertMaterial({color:16777215,map:s}),r,r];return d},It=function(e){return e||(e=event),e.detail<0?1:e.wheelDelta>0?1:-1},bt=function(e,t,n){return Math.abs(e.x-t.x)<=n&&Math.abs(e.y-t.y)<=n},Ht=function(e){e.style.opacity<=0?(e.style.display="none",e.style.opacity=0):(e.style.opacity-=.1,setTimeout(function(){Ht(e)},10))},Ct=function(e,t){e.style.opacity<N.infoPanelOpacity?("none"==e.style.display&&(e.style.display="block",t=0),t+=.03,e.style.opacity=t,setTimeout(function(){Ct(e,t)},10)):e.style.opacity=N.infoPanelOpacity},Ot=function(){H=N.canvasWidth?N.canvasWidth:n.clientWidth,C=N.canvasHeight?N.canvasHeight:n.clientHeight},zt=function(){o.style.height=C+"px",i.style.height=C+"px",a.style.height=C+"px",o.style.width=H+"px",i.style.width=H+"px",a.style.width=H+"px"};return S.init=function(e){if(N=Z(V,e),L&&Modernizr.webgl){if(console.log("initializing..."),console.log("options:",N),O=void 0!==window.devicePixelRatio?window.devicePixelRatio:1,n=document.getElementById(N.elements.rootContainerId),!n)return console.error("cratedigger.js - Init failed : can not find root container element."),void 0;if(o=document.getElementById(N.elements.canvasContainerId),!o)return console.error("cratedigger.js - Init failed : can not find canvas container element."),void 0;if(a=document.getElementById(N.elements.loadingContainerId),!a)return console.error("cratedigger.js - Init failed : can not find loading container element."),void 0;if(i=document.getElementById(N.elements.infosContainerId),!i)return console.error("cratedigger.js - Init failed : can not find infos container element."),void 0;if(s=document.getElementById(N.elements.titleContainerId),!s)return console.error("cratedigger.js - Init failed : can not find record title container element."),void 0;if(r=document.getElementById(N.elements.artistContainerId),!r)return console.error("cratedigger.js - Init failed : can not find record artist container element."),void 0;if(d=document.getElementById(N.elements.coverContainerId),!d)return console.error("cratedigger.js - Init failed : can not find cover image container element."),void 0;Ot(),pt()}},S.selectRecord=function(e){0>e?it():G=e>U?U-1:e},S.startRender=function(){D=!0,J()},S.stopRender=function(){D=!1},S.enablePostprocessing=function(){N.postprocessing=!0},S.disablePostprocessing=function(){N.postprocessing=!1},S.getCanvas=function(){return f.domElement},S.getRecordsDataList=function(){return j},S.getSelectedRecord=function(){return B[G]},S.loadRecords=_,S.unloadRecords=$,S.resetShownRecord=it,S.shuffleRecords=et,S});