!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t:e.cratedigger=t(e)}(this,function(e){"use strict";function t(e){for(var t,n,o=e.length;o;t=parseInt(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n);return e}var n,o,i,s,a,r,c,d,l,u,E,m,h,p,f,g,T,y,w,v,I,M,R={},P={},x=!!document.querySelector&&!!e.addEventListener,b=[],O=[],H=[],W="closed",C=!0,z={x:0,y:0},N={x:0,y:0},B={x:0,y:0},L=-1,S=-1,j=0,Q={debug:!0,canvasWidth:null,canvasHeight:null,nbCrates:2,recordsPerCrate:24,lightIntensity:1,cameraMouseMove:!0,backgroundColor:1118481,sleeveColor:853762,closeInfoPanelOnClick:!0,closeInfoPanelOnScroll:!0,infoPanelOpacity:.9,updateCanvasSizeOnWindowResize:!1,callbackBefore:function(){},callbackAfter:function(){},elements:{rootContainerId:"cratedigger",canvasContainerId:"cratedigger-canvas",loadingContainerId:"cratedigger-loading",infosContainerId:"cratedigger-infos",titleContainerId:"cratedigger-record-title",artistContainerId:"cratedigger-record-artist",coverContainerId:"cratedigger-record-cover"},constants:{recordMoveTime:1e3,cameraMoveTime:800,infosOpenTime:800,recordShownY:25,recordFlippedY:110,cameraBasePosition:{x:270,y:180,z:110},cameraFocusPosition:{x:140,y:180,z:80},cameraMouseMoveSpeedY:.07,cameraMouseMoveSpeedZ:.03,grabSensitivity:6}},k=function(e,t,n){this.id=e,this.crateId=t,this.pos=n,this.state="out",this.recordXPos=-62+135/R.recordsPerCrate*n,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,1.5,100,1,1,1),new THREE.MeshFaceMaterial(mt(null,!1))),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(50,0,0)),this.mesh.position.set(this.recordXPos,0,0),this.mesh.rotation.z=Math.PI/2,this.mesh.recordId=e,this.mesh.visible=!1,this.absolutePosition=new THREE.Vector3,this.pushRecord()};k.prototype.log=function(){console.log("Record nÂ°",this.id,"crateId =",this.crateId,"pos =",this.pos)},k.prototype.showRecord=function(){"shown"!==this.state&&(this.state="shown",this.absolutePosition.setFromMatrixPosition(this.mesh.matrixWorld),new TWEEN.Tween(this.mesh.position).to({y:R.constants.recordShownY},R.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2},R.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(E.position).to({x:this.recordXPos,y:50+R.constants.recordShownY,z:this.absolutePosition.z},R.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(u.position).to({x:this.recordXPos+R.constants.cameraFocusPosition.x,y:R.constants.cameraFocusPosition.y,z:this.absolutePosition.z+R.constants.cameraFocusPosition.z},R.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},k.prototype.pushRecord=function(){"pushed"!=this.state&&(this.state="pushed",new TWEEN.Tween(this.mesh.position).to({y:0},R.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2+Math.PI/7},R.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},k.prototype.pullRecord=function(){"pulled"!==this.state&&(this.state="pulled",new TWEEN.Tween(this.mesh.position).to({y:0},R.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2-Math.PI/7},R.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},k.prototype.flipRecord=function(e){this.state="flipped",new TWEEN.Tween(this.mesh.position).to({y:R.constants.recordFlippedY},R.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).delay(R.constants.infosOpenTime/4).to({y:Math.PI},R.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(E.position).to({x:this.recordXPos,y:R.constants.recordFlippedY+50,z:this.absolutePosition.z},R.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e)},k.prototype.flipBackRecord=function(e){"flipped"===this.state&&(new TWEEN.Tween(this.mesh.position).delay(R.constants.infosOpenTime/2).to({y:0},R.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({y:0},R.constants.infosOpenTime/2).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),new TWEEN.Tween(E.position).delay(R.constants.infosOpenTime/2).to({x:this.recordXPos,y:75,z:this.absolutePosition.z},R.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start())};var Y=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},F=function(){C&&(requestAnimationFrame(F),X(),R.debug&&d.update())},X=function(){TWEEN.update(),Z(),R.cameraMouseMove&&(B.x=.25*(z.x/w-.5),B.y=.25*(z.y/w-.5),T.rotation.y+=R.constants.cameraMouseMoveSpeedY*(B.x-T.rotation.y),T.rotation.z+=R.constants.cameraMouseMoveSpeedZ*(B.y-T.rotation.z)),u.lookAt(E.position),m.render(l,u)},G=function(){for(var e=0;e<O.length;e++)O[e].data=null,O[e].mesh.visible=!1;j=0,H=[]},D=function(e){j>0&&G();for(var t=0;t<O.length&&t<e.length;t++)O[t].data=e[t],O[t].mesh.visible=!0,O[t].mesh.material.materials=mt(e[t].cover,e[t].hasSleeve);j=e.length<O.length?e.length:O.length,H=e,console.log("loadedRecords",j)},A=function(){var e=H;e=t(e),D(e)},U=function(e){"opened"===W?q():"opening"!==W&&"closing"!==W&&(L=e)},V=function(){_(O[L]),W="opening",O[L].flipRecord(function(){W="opened"}),setTimeout(function(){gt(s)},300)},q=function(){"opened"===W&&(ft(s),W="closing",O[L].flipBackRecord(function(){W="closed"}))},Z=function(){if("closed"===W&&S!=L){S=L;for(var e=0;j>e;e++)-1==L?O[e].pushRecord():e>L&&e>O[L].crateId*R.recordsPerCrate&&e<O[L].crateId*R.recordsPerCrate+R.recordsPerCrate?O[e].pullRecord():e==L?O[e].showRecord():O[e].pushRecord()}},J=function(){"opened"===W?q():"opening"!==W&&"closing"!==W&&(L=-1,new TWEEN.Tween(E.position).to({x:0,y:0,z:0},R.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(u.position).to({x:R.constants.cameraBasePosition.x,y:R.constants.cameraBasePosition.y,z:R.constants.cameraBasePosition.z},R.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},K=function(){-1==L?U(j-1):j-1>L?U(L+1):U(0)},$=function(){-1==L?U(0):L>0?U(L-1):U(j-1)},_=function(e){e.data.title&&(a.innerHTML=e.data.title),e.data.artist&&(r.innerHTML=e.data.artist),e.data.cover&&(c.style.backgroundImage="url("+e.data.cover+")")},et=function(e){var t=0,n=0,o=0,i=0,s=this;if(e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),s.offsetParent)do o+=s.offsetLeft,i+=s.offsetTop;while(s=s.offsetParent);z.x=t-o,z.y=n-i},tt=function(e){return"closed"===W?ht(e)<0?K():$():"opened"===W&&R.closeInfoPanelOnScroll&&q(),!1},nt=function(e){if("closed"===W){var t=new THREE.Vector3((e.x-m.domElement.offsetLeft)/m.domElement.width*2-1,2*-((e.y-m.domElement.offsetTop)/m.domElement.height)+1,.5);h.unprojectVector(t,u);var n=new THREE.Raycaster(u.position,t.sub(u.position).normalize()),o=n.intersectObjects(y.children,!0);if(o.length>0&&o[0].object.recordId>=0){var i=O[o[0].object.recordId];L===i.id?V():U(i.id)}else J()}},ot=function(){clearInterval(I),"closed"===W?(st(z.y),N={x:z.x,y:z.y}):"opened"===W&&R.closeInfoPanelOnClick&&q()},it=function(){clearInterval(I),classie.remove(m.domElement,"grab"),pt(N,z,R.constants.grabSensitivity)&&nt(N)},st=function(e){I=setTimeout(function(){classie.add(m.domElement,"grab");var t=(e-z.y)/v;t>0?$():0>t&&K(),st(e)},75)},at=function(){Tt(),yt(),m.setSize(w,v),u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix()},rt=function(){l=new THREE.Scene,m=new THREE.WebGLRenderer({antialias:!0}),m.setSize(w,v),o.appendChild(m.domElement),m.domElement.id="context",m.setClearColor(R.backgroundColor,1),u=new THREE.PerspectiveCamera(45,w/v,.1,2e4),E=new THREE.Object3D,u.lookAt(E.position),h=new THREE.Projector;var e=THREE.ImageUtils.loadTexture("img/wood.jpg");e.anisotropy=m.getMaxAnisotropy(),M=new THREE.MeshLambertMaterial({map:e}),T=new THREE.Object3D,y=new THREE.Object3D,l.add(T),T.add(y),dt(),ut(),p=new THREE.PointLight(16777215,1.1*R.lightIntensity),p.position.set(300,80,0),l.add(p),f=new THREE.PointLight(16777215,.6*R.lightIntensity),f.position.set(-100,300,1e3),l.add(f),g=new THREE.PointLight(16777215,.6*R.lightIntensity),g.position.set(-100,300,-1e3),l.add(g),n.addEventListener("DOMMouseScroll",tt,!1),n.addEventListener("mousewheel",tt,!1),n.addEventListener("mousemove",et,!1),n.addEventListener("mousedown",ot,!1),n.addEventListener("mouseup",it,!1),R.updateCanvasSizeOnWindowResize&&window.addEventListener("resize",at,!1),n.style.position="relative",o.style.position="absolute",s.style.position="absolute",i.style.position="absolute",console.log(v),yt(),s.style.display="none",ft(i),R.debug&&ct(),J(),F()},ct=function(){d=new Stats,d.domElement.style.position="absolute",d.domElement.style.left="0",d.domElement.style.top="0",n.appendChild(d.domElement);var e=new THREE.Mesh(new THREE.BoxGeometry(20,20,20,1,1,1));e.position.set(p.position.x,p.position.y,p.position.z),l.add(e)},dt=function(){for(var e=0;e<R.nbCrates;e++){var t=lt(e);y.add(t)}y.position.z=-(110-110*R.nbCrates)/2},lt=function(e){b[e]=new THREE.Object3D;var t=new THREE.Mesh(new THREE.BoxGeometry(200,10,100),M);b[e].add(t);var n=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),M);if(n.position.set(0,35,-55),n.rotation.x=Math.PI/2,b[e].add(n),0===e){var o=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),M);o.position.set(0,35,55),o.rotation.x=Math.PI/2,b[e].add(o)}var i=new THREE.Mesh(new THREE.BoxGeometry(80,10,120),M);i.position.set(-105,35,0),i.rotation.z=Math.PI/2,b[e].add(i);var s=new THREE.Mesh(new THREE.BoxGeometry(40,10,100),M);return s.position.set(95,25,0),s.rotation.z=Math.PI/2,b[e].add(s),b[e].position.z=-110*e,b[e]},ut=function(){for(var e=0,t=0;t<b.length;t++)for(var n=0;n<R.recordsPerCrate;n++)Et(e,t,n),e++},Et=function(e,t,n){var o=new k(e,t,n);b[t].add(o.mesh),O.push(o)},mt=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.src=e?e:"";var o=400,i=400,s=document.createElement("canvas");s.width=s.height=400;var a=new THREE.Texture(s);n.onload=function(){if(t){var e=new Image;e.src="img/sleeve.png",e.onload=function(){var t=s.getContext("2d");t.translate(o/2,i/2),t.rotate(Math.PI/2),t.translate(-o/2,-i/2),t.drawImage(n,130,130,135,135),t.drawImage(e,0,0,400,400),a.needsUpdate=!0}}else{var r=s.getContext("2d");r.translate(o/2,i/2),r.rotate(Math.PI/2),r.translate(-o/2,-i/2),r.drawImage(n,0,0,400,400),a.needsUpdate=!0}};var r=new THREE.MeshLambertMaterial({color:R.sleeveColor}),c=[r,r,r,new THREE.MeshLambertMaterial({color:16777215,map:a}),r,r];return c},ht=function(e){return e||(e=event),e.detail<0?1:e.wheelDelta>0?1:-1},pt=function(e,t,n){return Math.abs(e.x-t.x)<=n&&Math.abs(e.y-t.y)<=n},ft=function(e){e.style.opacity<=0?(e.style.display="none",e.style.opacity=0):(e.style.opacity-=.1,setTimeout(function(){ft(e)},10))},gt=function(e,t){e.style.opacity<R.infoPanelOpacity?("none"==e.style.display&&(e.style.display="block",t=0),t+=.03,e.style.opacity=t,setTimeout(function(){gt(e,t)},10)):e.style.opacity=R.infoPanelOpacity},Tt=function(){w=R.canvasWidth?R.canvasWidth:n.clientWidth,v=R.canvasHeight?R.canvasHeight:n.clientHeight},yt=function(){o.style.height=v+"px",s.style.height=v+"px",i.style.height=v+"px",o.style.width=w+"px",s.style.width=w+"px",i.style.width=w+"px"};return P.init=function(e){if(R=Y(Q,e),x&&Modernizr.webgl){if(console.log("initializing..."),console.log("options:",R),n=document.getElementById(R.elements.rootContainerId),!n)return console.error("cratedigger.js - Init failed : can not find root container element."),void 0;if(o=document.getElementById(R.elements.canvasContainerId),!o)return console.error("cratedigger.js - Init failed : can not find canvas container element."),void 0;if(i=document.getElementById(R.elements.loadingContainerId),!i)return console.error("cratedigger.js - Init failed : can not find loading container element."),void 0;if(s=document.getElementById(R.elements.infosContainerId),!s)return console.error("cratedigger.js - Init failed : can not find infos container element."),void 0;if(a=document.getElementById(R.elements.titleContainerId),!a)return console.error("cratedigger.js - Init failed : can not find record title container element."),void 0;if(r=document.getElementById(R.elements.artistContainerId),!r)return console.error("cratedigger.js - Init failed : can not find record artist container element."),void 0;if(c=document.getElementById(R.elements.coverContainerId),!c)return console.error("cratedigger.js - Init failed : can not find cover image container element."),void 0;Tt(),rt()}},P.selectRecord=function(e){0>e?J():L=e>j?j-1:e},P.startRender=function(){C=!0,F()},P.stopRender=function(){C=!1},P.canvas=function(){return m.domElement},P.recordsDataList=function(){return H},P.loadRecords=D,P.unloadRecords=G,P.resetShownRecord=J,P.shuffleRecords=A,P});