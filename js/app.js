var API=function(){function init(){jQuery.ajaxSettings.traditional=!0}function getPlaylistFromArtist(artist,done){playlistIDs=[];var args={name:artist};callApi("artist/similar",args,null,function(error,data){error?console.log("error"):(artists=$.map(data.artists,function(item){return item.name}),artists.unshift(artist),requestPlaylistPart({fromYear:1990,toYear:1999,results:48,artists:artists},null,null,function(playlist){newPlaylist=shuffle(playlist),done(playlist)}))})}function callApi(action,args,options,done,doneFormatting){var defaults={api_key:apiKey},url="http://developer.echonest.com/api/v4/"+action;args=$.extend({},defaults,args),$.getJSON(url,args,function(data){0===data.response.status.code?done(!1,data.response,options,doneFormatting):done(!0)},function(){done(!0)})}function requestPlaylistPart(options,playlist,reqCount,onPlaylistLoaded){reqCount=reqCount?reqCount:0;var currentArtist=options.artists[reqCount]?options.artists[reqCount]:options.artists[0];console.log(currentArtist);var args={results:40,artist:currentArtist,bucket:["id:deezer","tracks"],type:"artist-radio",adventurousness:1,variety:1,distribution:"wandering"};maxReq>=reqCount&&(reqCount+=1,callApi("playlist/static",args,options,onPlaylistPartGet,function(songs){onPlaylistPartFormatted(options,songs,playlist,reqCount,onPlaylistLoaded)}))}function onPlaylistPartFormatted(options,songs,playlist,reqCount,playlistLoaded){playlist=playlist?playlist.concat(songs):songs,playlist.length<options.results&&maxReq>=reqCount?requestPlaylistPart(options,playlist,reqCount,playlistLoaded):(playlist=playlist.slice(0,options.results),callUrl302(playlist,function(error,newPlaylist){error||playlistLoaded(newPlaylist)}))}function onPlaylistPartGet(error,response,options,doneFormatting){if(!error){var songs=$.map(response.songs,function(song){return formatResponseSong(song,options)});doneFormatting(songs)}}function formatResponseSong(songData,options){if(tracksData=getDataFromTracks(songData.tracks,options),tracksData&&-1===$.inArray(songData.id,playlistIDs)){console.log(playlistIDs.length);var song={title:songData.title,artist:songData.artist_name,cover:tracksData.cover,year:tracksData.year,deezer_id:tracksData.id,deezer_releaseId:tracksData.release_id,hasSleeve:!1};return playlistIDs.push(songData.id),song}return null}function getDataFromTracks(tracks){var length=tracks.length,data={cover:null,year:null};if(length){for(var i=0;length>i;i++)if("deezer"==tracks[i].catalog&&tracks[i].album_date){data.year=tracks[i].album_date.substring(0,4),data.id=tracks[i].foreign_id.split(":")[2],data.release_id=tracks[i].foreign_release_id.split(":")[2],data.cover="http://api.deezer.com/album/"+data.release_id+"/image?size=big";break}return data.cover&&data.year?data:null}return!1}function callUrl302(data,done){var url="https://url302.herokuapp.com/";$.ajax({type:"POST",url:url,dataType:"json",headers:{"Content-Type":"application/json"},data:JSON.stringify(data),success:function(data){done(!1,data)},error:function(){done(!0)}})}function shuffle(v){for(var j,x,i=v.length;i;j=parseInt(Math.random()*i),x=v[--i],v[i]=v[j],v[j]=x);return v}var apiKey="ASJCKIVQOBWZNXULY",maxReq=15,playlistIDs=[];return{init:init,getPlaylistFromArtist:getPlaylistFromArtist}}(),GUI=function(){function init(){$searchInput=$("#artist-search-input"),$artistSearchContainer=$("#artist-search"),$bottomBar=$("#bottom-bar"),$listenButton=$("#cratedigger-record-listen"),initEventListeners()}function initEventListeners(){$searchInput.keypress(searchInputKeypressHandler),$listenButton.on("click",listenButtonClickHandler)}function searchInputKeypressHandler(e){13==e.which&&$searchInput.val()&&""!==$searchInput.val()&&($searchInput.prop("disabled",!0),API.getPlaylistFromArtist($searchInput.val(),function(){setTimeout(function(){$artistSearchContainer.fadeOut(1e3)},2e3)}))}function listenButtonClickHandler(e){return e.stopPropagation(),DeezerPlayer.playTrack(cratedigger.getSelectedRecord()),!1}function openBottomBar(){}function closeBottomBar(){}var $searchInput,$artistSearchContainer,$bottomBar,$listenButton;return{init:init,openBottomBar:openBottomBar,closeBottomBar:closeBottomBar}}(),DeezerPlayer=function(){function init(){DZ.init({appId:"146221",channelUrl:"http://developers.deezer.com/examples/channel.php",player:{container:"player",width:400,height:80,playlist:!1,onload:onPlayerLoaded}})}function onPlayerLoaded(){}function playTrack(record){console.log(record);var id=record.data.deezer_id;console.log("play id:",id),DZ.player.playTracks([id])}return{init:init,playTrack:playTrack}}(),App=function(){function init(){cratedigger.init({infoPanelOpened:function(){GUI.openBottomBar()},infoPanelClosed:function(){GUI.openBottomBar()},elements:{rootContainerId:"cratedigger",canvasContainerId:"cratedigger-canvas",loadingContainerId:"cratedigger-loading",infosContainerId:"cratedigger-infos",titleContainerId:"cratedigger-record-title",artistContainerId:"cratedigger-record-artist",coverContainerId:"cratedigger-record-cover"}}),API.init(),GUI.init(),DeezerPlayer.init(),API.getPlaylistFromArtist("the roots",function(playlist){cratedigger.loadRecords(playlist)})}return{init:init}}();$(function(){App.init()});